<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">File Manager - {{ .Gameserver.Name }}</h1>
        <a href="/{{ .Gameserver.ID }}" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
            Back to Gameserver
        </a>
    </div>

    <div class="bg-white rounded-lg shadow">
        <!-- File browser toolbar -->
        <div class="border-b px-4 py-3">
            <!-- Breadcrumb navigation -->
            <div class="flex items-center justify-between mb-2">
                <nav class="flex items-center text-sm" id="breadcrumb">
                    <!-- Breadcrumbs will be generated by JavaScript -->
                </nav>
                <div class="flex items-center space-x-2">
                    <button onclick="showCreateDialog()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                        New File/Folder
                    </button>
                    <button onclick="refreshFiles()" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">
                        Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Split view container -->
        <div class="flex" style="height: 600px;">
            <!-- File browser (left pane) -->
            <div id="file-browser" class="w-1/3 border-r overflow-y-auto">
                {{ template "file-browser.html" . }}
            </div>

            <!-- File editor (right pane) -->
            <div id="file-editor" class="w-2/3 flex flex-col">
                <div class="p-4 text-center text-gray-500">
                    <p>Select a file to view or edit</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create file/folder dialog -->
<div id="create-dialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-96">
        <h3 class="text-lg font-bold mb-4">Create New</h3>
        <form id="create-form" hx-post="/{{ .Gameserver.ID }}/files/create" hx-target="#file-browser">
            <input type="hidden" name="path" id="create-path" value="{{ .CurrentPath }}">
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Type</label>
                <select name="type" class="w-full border rounded px-3 py-2">
                    <option value="file">File</option>
                    <option value="directory">Directory</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Name</label>
                <input type="text" name="name" required class="w-full border rounded px-3 py-2" placeholder="filename.txt">
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="hideCreateDialog()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Cancel
                </button>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Create
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentPath = '{{ .CurrentPath }}';
let currentFile = null;
let editor = null;
const baseDir = '/data';

function navigateTo(path) {
    // Ensure we stay within /data
    if (!path.startsWith(baseDir)) {
        path = baseDir;
    }
    
    currentPath = path;
    document.getElementById('create-path').value = path;
    updateBreadcrumb(path);
    
    htmx.ajax('GET', `/{{ .Gameserver.ID }}/files/browse?path=${encodeURIComponent(path)}`, {
        target: '#file-browser',
        swap: 'innerHTML'
    });
}

function updateBreadcrumb(path) {
    const breadcrumb = document.getElementById('breadcrumb');
    const parts = path.split('/').filter(p => p !== '');
    
    let breadcrumbHtml = '';
    let currentPath = '';
    
    // Add root /data breadcrumb
    breadcrumbHtml += `<button onclick="navigateTo('/data')" class="text-blue-600 hover:text-blue-800 font-medium">data</button>`;
    currentPath = '/data';
    
    // Add subsequent path parts
    for (let i = 1; i < parts.length; i++) {
        const part = parts[i];
        currentPath += '/' + part;
        
        breadcrumbHtml += `<span class="mx-2 text-gray-400">/</span>`;
        
        if (i === parts.length - 1) {
            // Current directory - not clickable
            breadcrumbHtml += `<span class="text-gray-700 font-medium">${part}</span>`;
        } else {
            // Parent directories - clickable
            const pathForClick = currentPath;
            breadcrumbHtml += `<button onclick="navigateTo('${pathForClick}')" class="text-blue-600 hover:text-blue-800 font-medium">${part}</button>`;
        }
    }
    
    breadcrumb.innerHTML = breadcrumbHtml;
}

function selectFile(path) {
    currentFile = path;
    
    // Show loading state
    document.getElementById('file-editor').innerHTML = '<div class="p-4 text-center"><p>Loading...</p></div>';
    
    fetch(`/{{ .Gameserver.ID }}/files/content?path=${encodeURIComponent(path)}`)
        .then(response => response.json())
        .then(data => {
            if (data.IsBinary) {
                showBinaryFile(path);
            } else {
                showTextEditor(path, data.Content);
            }
        })
        .catch(error => {
            document.getElementById('file-editor').innerHTML = '<div class="p-4 text-center text-red-500"><p>Error loading file</p></div>';
        });
}

function showTextEditor(path, content) {
    const filename = path.split('/').pop();
    const editorHtml = `
        <div class="border-b px-4 py-2 flex items-center justify-between bg-gray-50">
            <span class="font-mono text-sm">${filename}</span>
            <div class="space-x-2">
                <button onclick="saveFile()" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                    Save
                </button>
                <button onclick="downloadFile('${path}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                    Download
                </button>
            </div>
        </div>
        <div id="code-editor" class="flex-1"></div>
    `;
    
    document.getElementById('file-editor').innerHTML = editorHtml;
    
    // Initialize CodeMirror
    const editorElement = document.getElementById('code-editor');
    editor = CodeMirror(editorElement, {
        value: content,
        mode: getFileMode(filename),
        theme: 'default',
        lineNumbers: true,
        lineWrapping: false,
        scrollbarStyle: 'native'
    });
    
    // Set editor size
    editor.setSize('100%', '100%');
}

function showBinaryFile(path) {
    const filename = path.split('/').pop();
    document.getElementById('file-editor').innerHTML = `
        <div class="p-4 text-center">
            <p class="text-gray-600 mb-4">Binary file: ${filename}</p>
            <button onclick="downloadFile('${path}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Download File
            </button>
        </div>
    `;
}

function getFileMode(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const modes = {
        'js': 'javascript',
        'json': 'application/json',
        'html': 'htmlmixed',
        'xml': 'xml',
        'css': 'css',
        'py': 'python',
        'sh': 'shell',
        'bash': 'shell',
        'yml': 'yaml',
        'yaml': 'yaml',
        'toml': 'toml',
        'ini': 'properties',
        'properties': 'properties',
        'md': 'markdown',
        'sql': 'sql',
        'go': 'go',
        'java': 'text/x-java',
        'c': 'text/x-csrc',
        'cpp': 'text/x-c++src',
        'h': 'text/x-csrc',
        'hpp': 'text/x-c++src'
    };
    return modes[ext] || 'text/plain';
}

function saveFile() {
    if (!editor || !currentFile) return;
    
    const content = editor.getValue();
    
    fetch(`/{{ .Gameserver.ID }}/files/save`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `path=${encodeURIComponent(currentFile)}&content=${encodeURIComponent(content)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'saved') {
            showNotification('File saved successfully', 'success');
        }
    })
    .catch(error => {
        showNotification('Error saving file', 'error');
    });
}

function downloadFile(path) {
    window.location.href = `/{{ .Gameserver.ID }}/files/download?path=${encodeURIComponent(path)}`;
}

function deleteFile(path) {
    if (!confirm(`Are you sure you want to delete ${path}?`)) return;
    
    fetch(`/{{ .Gameserver.ID }}/files/delete?path=${encodeURIComponent(path)}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (response.ok) {
            refreshFiles();
            if (currentFile === path) {
                document.getElementById('file-editor').innerHTML = '<div class="p-4 text-center text-gray-500"><p>Select a file to view or edit</p></div>';
                currentFile = null;
                editor = null;
            }
        }
    });
}

function showCreateDialog() {
    document.getElementById('create-dialog').classList.remove('hidden');
}

function hideCreateDialog() {
    document.getElementById('create-dialog').classList.add('hidden');
}

function refreshFiles() {
    navigateTo(currentPath);
}

function showNotification(message, type) {
    // Simple notification (you can enhance this with a proper notification system)
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Handle keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveFile();
    }
});

// Initialize breadcrumb on page load
document.addEventListener('DOMContentLoaded', function() {
    updateBreadcrumb(currentPath);
});
</script>

<!-- Include CodeMirror CSS and JS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/shell/shell.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/yaml/yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/toml/toml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/properties/properties.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/go/go.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>

<style>
.CodeMirror {
    font-family: 'Courier New', monospace;
    font-size: 14px;
}
</style>