<!-- Unified gameserver form for both new and edit -->
{{$isEdit := .Gameserver}}
{{$gameserver := .Gameserver}}
{{$games := .Games}}
{{$mods := .Mods}}

<div>
  <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
    <!-- Form header -->
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div
            class="flex-shrink-0 w-10 h-10 {{if $isEdit}}bg-blue-100 dark:bg-blue-900{{else}}bg-green-100 dark:bg-green-900{{end}} rounded-lg flex items-center justify-center">
            <svg
              class="w-6 h-6 {{if $isEdit}}text-blue-600 dark:text-blue-400{{else}}text-green-600 dark:text-green-400{{end}}"
              fill="none" stroke="currentColor" viewBox="0 0 24 24">
              {{if $isEdit}}
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
              </path>
              {{else}}
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              {{end}}
            </svg>
          </div>
          <div>
            <h1 class="text-xl font-semibold text-gray-900 dark:text-gray-100">{{if $isEdit}}Edit Server{{else}}Create
              New Server{{end}}</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400">{{if $isEdit}}Modify {{$gameserver.Name}}
              configuration{{else}}Set up a new gameserver with your preferred configuration{{end}}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Form content -->
    <form {{if $isEdit}}hx-put="/gameservers/{{$gameserver.ID}}" {{else}}hx-post="/gameservers" {{end}} hx-indicator="#form-loading"
      hx-swap="none"
      hx-on::after-request="if(event.detail.successful) { {{if $isEdit}}showNotification('Server updated successfully', 'success');{{else}}window.location.href = '/gameservers/' + event.detail.xhr.getResponseHeader('X-Server-ID');{{end}} } else { showNotification('Failed to {{if $isEdit}}update{{else}}create{{end}} server', 'error'); }">
      <div class="p-6 space-y-8">
        <!-- Single game_id input for both create and edit -->
        <input type="hidden" id="game_id" name="game_id" value="{{if $isEdit}}{{$gameserver.GameID}}{{end}}" required>

        {{if not $isEdit}}
        <!-- Game Selection -->
        <div class="space-y-4">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-2">
            Select Game
          </h3>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {{range $games}}
            <div class="game-card relative group cursor-pointer" data-game-id="{{.ID}}" onclick="selectGame('{{.ID}}')">
              <div class="relative overflow-hidden rounded-lg border-2 border-gray-200 dark:border-gray-700 hover:border-blue-500 dark:hover:border-blue-400 transition-all duration-200 transform hover:-translate-y-1 hover:shadow-lg">
                {{if .GridImagePath}}
                  <img src="{{.GridImagePath}}" alt="{{.Name}}" class="w-full h-auto">
                {{else}}
                  <div class="aspect-video w-full bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800 flex items-center justify-center">
                    <span class="text-lg font-medium text-gray-600 dark:text-gray-300">{{.Name}}</span>
                  </div>
                {{end}}
                
                <!-- Selected overlay -->
                <div class="selected-overlay absolute inset-0 bg-blue-600 bg-opacity-90 hidden flex items-center justify-center">
                  <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                  </svg>
                </div>
              </div>
              <p class="mt-2 text-center text-sm font-medium text-gray-700 dark:text-gray-300">{{.Name}}</p>
            </div>
            {{end}}
          </div>
          
          <p id="game-selection-error" class="text-red-500 text-sm mt-2 hidden">Please select a game to continue</p>
        </div>
        {{end}}

        <!-- Basic Information -->
        <div class="space-y-4" {{if not $isEdit}}id="basic-info-section" style="display: none;"{{end}}>
          <h3
            class="text-lg font-semibold text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-2">
            Basic Information</h3>

          <div class="grid gap-6 sm:grid-cols-2">
            <div>
              <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Server
                Name</label>
              <input type="text" id="name" name="name" required {{if $isEdit}}value="{{$gameserver.Name}}" {{end}}
                class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 transition-smooth"
                placeholder="My Awesome Server">
            </div>
          </div>
        </div>

        {{if not $isEdit}}
        <!-- Network / Ports -->
        <div class="space-y-4" id="network-section" style="display: none;">
          <div class="flex items-center justify-between border-b border-gray-200 dark:border-gray-700 pb-2">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Network</h3>
            <div class="flex items-center space-x-3">
              <span class="text-xs text-gray-500 dark:text-gray-400" id="port-mode-label">Manual</span>
              <button type="button" id="port-mode-toggle" onclick="togglePortMode()"
                class="relative inline-flex h-5 w-9 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 bg-blue-600"
                role="switch" aria-checked="true" title="Toggle between manual and automatic port assignment">
                <span id="port-mode-knob" class="pointer-events-none inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-4"></span>
              </button>
            </div>
          </div>

          <input type="hidden" name="port_mode" id="port_mode" value="manual">
          <input type="hidden" name="port_mappings" id="port_mappings" value="">

          <!-- Manual port inputs -->
          <div id="port-inputs">
            <div id="port-fields" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
              <!-- Dynamic port fields will be inserted here by JavaScript -->
            </div>
          </div>

          <!-- Auto mode info -->
          <p id="port-auto-info" class="hidden text-sm text-gray-500 dark:text-gray-400">
            Ports will be automatically assigned sequentially starting from 49152
          </p>
        </div>
        {{end}}

        <!-- Game Configuration -->
        <div class="space-y-4" id="config-section" {{if not $isEdit}}style="display: none;" {{else}}style="display: block;" {{end}}>
          <h3
            class="text-lg font-semibold text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-2">
            Game Configuration</h3>
          <div id="config-fields" class="grid gap-6 sm:grid-cols-2">
            <!-- Dynamic config fields will be inserted here -->
          </div>
        </div>

        <!-- Mods Section -->
        <div class="space-y-4" id="mods-section" style="display: none;">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-2">
            Mods
          </h3>
          <div id="mods-fields" class="grid gap-4 sm:grid-cols-2">
            <!-- Dynamic mod checkboxes will be inserted here -->
          </div>
          <p id="no-mods-message" class="text-sm text-gray-500 dark:text-gray-400 hidden">
            No mods available for this game.
          </p>
        </div>

        <!-- Resource Allocation -->
        <div class="space-y-6" {{if not $isEdit}}id="resource-section" style="display: none;"{{end}}>
          <h3
            class="text-lg font-semibold text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-2">
            Resource Allocation</h3>

          <!-- Memory Slider -->
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <label for="memory_slider" class="text-sm font-medium text-gray-700 dark:text-gray-300">Memory
                (RAM)</label>
              <div class="flex items-center space-x-2">
                <span id="memory-value" class="text-lg font-semibold text-blue-600 dark:text-blue-400">{{if
                  $isEdit}}{{$gameserver.MemoryGB}}{{else}}2{{end}} GB</span>
                <div id="memory-recommendation" class="text-xs text-gray-500 dark:text-gray-400"></div>
              </div>
            </div>

            <div class="space-y-2">
              <input type="range" id="memory_slider" min="1" max="16" step="1" {{if
                $isEdit}}value="{{$gameserver.MemoryGB}}" {{else}}value="2" {{end}}
                class="w-full h-3 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer slider">

              <div class="flex justify-between text-xs px-2">
                <span id="tick-1" class="text-gray-400">1</span>
                <span id="tick-2" class="text-gray-400">2</span>
                <span id="tick-3" class="text-gray-400">3</span>
                <span id="tick-4" class="text-gray-400">4</span>
                <span id="tick-5" class="text-gray-400">5</span>
                <span id="tick-6" class="text-gray-400">6</span>
                <span id="tick-7" class="text-gray-400">7</span>
                <span id="tick-8" class="text-gray-400">8</span>
                <span id="tick-9" class="text-gray-400">9</span>
                <span id="tick-10" class="text-gray-400">10</span>
                <span id="tick-11" class="text-gray-400">11</span>
                <span id="tick-12" class="text-gray-400">12</span>
                <span id="tick-13" class="text-gray-400">13</span>
                <span id="tick-14" class="text-gray-400">14</span>
                <span id="tick-15" class="text-gray-400">15</span>
                <span id="tick-16" class="text-gray-400">16</span>
              </div>
            </div>

            <input type="hidden" id="memory_gb" name="memory_gb" {{if $isEdit}}value="{{$gameserver.MemoryGB}}"
              {{else}}value="2" {{end}}>

            <p class="text-xs text-gray-500 dark:text-gray-400">
              <span class="text-orange-500">‚óè</span> Minimum required memory
              <span class="ml-4 text-green-500">‚óè</span> Recommended memory for optimal performance
            </p>
          </div>

          <!-- Max Backups -->
          <div>
            <label for="max_backups" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Maximum
              Backups</label>
            <select id="max_backups" name="max_backups"
              class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 transition-smooth">
              <option value="0" {{if $isEdit}}{{if eq $gameserver.MaxBackups 0}}selected{{end}}{{end}}>Unlimited
              </option>
              <option value="3" {{if $isEdit}}{{if eq $gameserver.MaxBackups 3}}selected{{end}}{{end}}>3 backups
              </option>
              <option value="5" {{if $isEdit}}{{if eq $gameserver.MaxBackups 5}}selected{{end}}{{end}}>5 backups
              </option>
              <option value="7" {{if $isEdit}}{{if eq $gameserver.MaxBackups 7}}selected{{end}}{{else}}selected{{end}}>7
                backups (recommended)</option>
              <option value="10" {{if $isEdit}}{{if eq $gameserver.MaxBackups 10}}selected{{end}}{{end}}>10 backups
              </option>
              <option value="15" {{if $isEdit}}{{if eq $gameserver.MaxBackups 15}}selected{{end}}{{end}}>15 backups
              </option>
            </select>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Older backups will be automatically deleted when
              this limit is reached</p>
          </div>
        </div>

        <!-- Advanced Settings (Collapsible) -->
        <div class="space-y-4" {{if not $isEdit}}id="advanced-section" style="display: none;"{{end}}>
          <button type="button" id="advanced-toggle"
            class="flex items-center justify-between w-full p-4 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-smooth"
            onclick="toggleAdvancedSettings()">
            <div class="flex items-center space-x-3">
              <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                </path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
              <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Advanced Settings</span>
              <span class="text-xs text-gray-500 dark:text-gray-400">(Optional)</span>
            </div>
            <svg id="advanced-arrow" class="w-5 h-5 text-gray-400 transform transition-transform" fill="none"
              stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>

          <div id="advanced-settings"
            class="hidden space-y-6 p-6 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg">

            <!-- CPU Limit -->
            <div class="space-y-4">
              <div class="flex items-center justify-between">
                <label for="cpu_slider" class="text-sm font-medium text-gray-700 dark:text-gray-300">CPU Cores</label>
                <span id="cpu-value" class="text-lg font-semibold text-blue-600 dark:text-blue-400">{{if $isEdit}}{{if
                  eq $gameserver.CPUCores 0.0}}Unlimited{{else}}{{$gameserver.CPUCores}}
                  cores{{end}}{{else}}Unlimited{{end}}</span>
              </div>

              <div class="relative">
                <input type="range" id="cpu_slider" min="0" max="8" step="0.5" {{if
                  $isEdit}}value="{{$gameserver.CPUCores}}" {{else}}value="0" {{end}}
                  class="w-full h-3 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer slider">
                <!-- CPU slider tick marks -->
                <div class="flex justify-between text-xs text-gray-400 dark:text-gray-500 mt-1 px-2">
                  <span>‚àû</span>
                  <span>1</span>
                  <span>2</span>
                  <span>3</span>
                  <span>4</span>
                  <span>5</span>
                  <span>6</span>
                  <span>7</span>
                  <span>8</span>
                </div>
              </div>
              <input type="hidden" id="cpu_cores" name="cpu_cores" {{if $isEdit}}value="{{$gameserver.CPUCores}}"
                {{else}}value="0" {{end}}>
              <p class="text-xs text-gray-500 dark:text-gray-400">Set to 0 (unlimited) for best performance, or limit
                CPU usage if sharing resources</p>
            </div>

            <!-- Custom Environment Variables -->
            <div class="space-y-4">
              <h4 class="text-base font-medium text-gray-900 dark:text-gray-100">Additional Environment Variables</h4>
              <p class="text-sm text-gray-500 dark:text-gray-400">{{if $isEdit}}Environment variables not covered by the
                game configuration above. These will be added to the existing config vars.{{else}}Add custom environment
                variables that aren't covered by the game configuration above. Most users won't need this.{{end}}</p>

              <div id="env-vars" class="space-y-3">
                <!-- Dynamic environment variable inputs -->
              </div>

              <button type="button" onclick="addEnvVar()"
                class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-smooth">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Add Environment Variable
              </button>
            </div>
          </div>
        </div>

      </div>

      <!-- Form actions -->
      <div class="px-6 py-4 bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 rounded-b-lg">
        <div class="flex items-center justify-between">
          {{if $isEdit}}
          <a href="/gameservers/{{$gameserver.ID}}" hx-get="/gameservers/{{$gameserver.ID}}" hx-target="#content" hx-push-url="true" hx-swap="innerHTML" hx-disinherit="hx-on::after-request"
            class="inline-flex items-center px-4 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-smooth">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Cancel
          </a>
          {{else}}
          <a href="/gameservers" hx-get="/gameservers" hx-target="#content" hx-push-url="true" hx-swap="innerHTML" hx-disinherit="hx-on::after-request"
            class="inline-flex items-center px-4 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-smooth">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Cancel
          </a>
          {{end}}

          {{if $isEdit}}
          <!-- Update button -->
          <button type="submit"
            class="inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-smooth disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span class="button-text">Update Server</span>
          </button>

          <!-- Update and Restart button -->
          <button type="button" onclick="updateAndRestart()"
            class="inline-flex items-center px-6 py-3 bg-orange-600 hover:bg-orange-700 dark:bg-orange-500 dark:hover:bg-orange-600 text-white text-sm font-medium rounded-lg transition-smooth disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
              </path>
            </svg>
            <span>Update & Restart</span>
          </button>
          {{else}}
          <!-- Create button -->
          <button type="submit" id="create-button" {{if not $isEdit}}disabled{{end}}
            class="inline-flex items-center px-6 py-3 bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 text-white text-sm font-medium rounded-lg transition-smooth disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span class="button-text">Create Server</span>
          </button>
          {{end}}

          <!-- Localized loading indicator -->
          <div id="form-loading" class="htmx-indicator ml-3">
            <div
              class="inline-flex items-center px-3 py-2 {{if $isEdit}}bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200{{else}}bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200{{end}} text-sm rounded-lg">
              <svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 714 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
              </svg>
              {{if $isEdit}}Updating...{{else}}Creating...{{end}}
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<style>
  /* Custom slider styles */
  .slider::-webkit-slider-thumb {
    appearance: none;
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: #3b82f6;
    cursor: pointer;
    border: 2px solid #ffffff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .slider::-moz-range-thumb {
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: #3b82f6;
    cursor: pointer;
    border: 2px solid #ffffff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .slider::-webkit-slider-track {
    height: 8px;
    border-radius: 4px;
    background: linear-gradient(to right, #fbbf24 0%, #10b981 50%, #3b82f6 100%);
  }

  .slider::-moz-range-track {
    height: 8px;
    border-radius: 4px;
    background: linear-gradient(to right, #fbbf24 0%, #10b981 50%, #3b82f6 100%);
  }
  
  /* Selected game card styles */
  .game-card.selected .border-gray-200,
  .game-card.selected .dark\:border-gray-700 {
    border-color: rgb(59 130 246) !important;
  }
  
  .game-card.selected .selected-overlay {
    display: flex !important;
  }
</style>

<script>
  // Game configuration data
  const gameConfigs = {
  {{range $games}}
  "{{.ID}}": {
    name: "{{.Name}}",
    minMemoryMB: {{.MinMemoryMB}},
    recMemoryMB: {{.RecMemoryMB}},
    configVars: [
      {{range .ConfigVars}}
      {
        name: "{{.Name}}",
        displayName: "{{.DisplayName}}",
        type: "{{if .Type}}{{.Type}}{{else}}text{{end}}",
        options: "{{.Options}}",
        required: {{.Required}},
        default: "{{.Default}}",
        description: "{{.Description}}"
      },
      {{end}}
    ],
    portMappings: [
      {{range .PortMappings}}
      {
        name: "{{.Name}}",
        protocol: "{{.Protocol}}",
        containerPort: {{.ContainerPort}}
      },
      {{end}}
    ]
  },
  {{end}}
};

  // Available mods by game
  const gameMods = {};
  {{range $games}}
  gameMods["{{.ID}}"] = [];
  {{end}}
  {{range $mods}}
  gameMods["{{.GameID}}"].push({id: "{{.ID}}", name: "{{.Name}}", description: "{{.Description}}"});
  {{end}}

  {{if $isEdit}}
  // Currently enabled mods
  const currentEnabledMods = [
    {{range $gameserver.EnabledMods}}
    "{{.}}",
    {{end}}
  ];
  {{end}}

  const isEditMode = {{if $isEdit}}true{{else}} false{{end}};
  let selectedGameId = {{if $isEdit}}"{{$gameserver.GameID}}"{{else}}null{{end}};

  {{if $isEdit}}
  // Current environment variables from server - parse on client side
  const currentEnvArray = [
    {{range $gameserver.Environment}}
  "{{.}}",
    {{end}}
];

  const currentEnv = {};
  currentEnvArray.forEach(envVar => {
    const parts = envVar.split('=');
    if (parts.length >= 2) {
      const key = parts[0];
      const value = parts.slice(1).join('='); // Handle values with = in them
      currentEnv[key] = value;
    }
  });
  {{end}}

  {{if not $isEdit}}
  // Select a game (only for new gameservers)
  function selectGame(gameId) {
    // Update selected state
    selectedGameId = gameId;
    document.getElementById('game_id').value = gameId;
    
    // Update UI
    document.querySelectorAll('.game-card').forEach(card => {
      card.classList.remove('selected');
    });
    document.querySelector(`[data-game-id="${gameId}"]`).classList.add('selected');
    
    // Hide error message
    const errorEl = document.getElementById('game-selection-error');
    if (errorEl) errorEl.classList.add('hidden');
    
    // Show other sections
    const sections = ['basic-info-section', 'network-section', 'resource-section', 'advanced-section'];
    sections.forEach(sectionId => {
      const section = document.getElementById(sectionId);
      if (section) section.style.display = 'block';
    });
    
    // Enable create button
    const createButton = document.getElementById('create-button');
    if (createButton) createButton.disabled = false;
    
    // Load game configuration
    loadGameConfiguration(gameId);
  }
  {{end}}

  // Toggle advanced settings
  function toggleAdvancedSettings() {
    const settings = document.getElementById('advanced-settings');
    const arrow = document.getElementById('advanced-arrow');

    if (settings.classList.contains('hidden')) {
      settings.classList.remove('hidden');
      arrow.style.transform = 'rotate(180deg)';
    } else {
      settings.classList.add('hidden');
      arrow.style.transform = 'rotate(0deg)';
    }
  }

  // Port mode state (default to manual)
  let isManualPortMode = true;

  // Toggle port mode between auto and manual
  function togglePortMode() {
    isManualPortMode = !isManualPortMode;

    const toggle = document.getElementById('port-mode-toggle');
    const knob = document.getElementById('port-mode-knob');
    const label = document.getElementById('port-mode-label');
    const portInputs = document.getElementById('port-inputs');
    const portAutoInfo = document.getElementById('port-auto-info');
    const portModeHidden = document.getElementById('port_mode');

    if (isManualPortMode) {
      toggle.classList.remove('bg-gray-200', 'dark:bg-gray-700');
      toggle.classList.add('bg-blue-600');
      knob.classList.remove('translate-x-0');
      knob.classList.add('translate-x-4');
      label.textContent = 'Manual';
      portInputs.classList.remove('hidden');
      portAutoInfo.classList.add('hidden');
      portModeHidden.value = 'manual';

      // Populate port fields if game is selected
      if (selectedGameId) {
        populatePortFields(selectedGameId);
      }
    } else {
      toggle.classList.add('bg-gray-200', 'dark:bg-gray-700');
      toggle.classList.remove('bg-blue-600');
      knob.classList.add('translate-x-0');
      knob.classList.remove('translate-x-4');
      label.textContent = 'Auto';
      portInputs.classList.add('hidden');
      portAutoInfo.classList.remove('hidden');
      portModeHidden.value = 'auto';
    }
  }

  // Populate port fields based on selected game
  function populatePortFields(gameId) {
    const portFields = document.getElementById('port-fields');
    if (!portFields || !gameConfigs[gameId]) return;

    const game = gameConfigs[gameId];
    portFields.innerHTML = '';

    // Group ports by name to avoid duplicates in UI (TCP+UDP on same port)
    const seenNames = new Set();

    game.portMappings.forEach((pm, index) => {
      // Skip if we've already shown this port name
      if (seenNames.has(pm.name)) return;
      seenNames.add(pm.name);

      // Find all protocols for this port name
      const protocols = game.portMappings
        .filter(p => p.name === pm.name)
        .map(p => p.protocol.toUpperCase())
        .join('/');

      // Capitalize port name for display
      const displayName = pm.name.charAt(0).toUpperCase() + pm.name.slice(1);

      const div = document.createElement('div');
      div.innerHTML = `
        <label for="port_${pm.name}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          ${displayName} <span class="text-xs font-normal text-gray-500 dark:text-gray-400">${protocols}</span>
        </label>
        <div class="flex items-center gap-2">
          <input type="number" id="port_${pm.name}" min="1" max="65535" value="${pm.containerPort}"
                 class="flex-1 px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 font-mono">
          <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
          </svg>
          <span class="text-sm font-mono text-gray-500 dark:text-gray-400 flex-shrink-0">${pm.containerPort}</span>
        </div>
      `;
      portFields.appendChild(div);
    });
  }

  // Memory slider functionality
  function setupMemorySlider() {
    const memorySlider = document.getElementById('memory_slider');
    const memoryValue = document.getElementById('memory-value');
    const memoryHidden = document.getElementById('memory_gb');
    const memoryRecommendation = document.getElementById('memory-recommendation');

    if (!memorySlider) return;

    memorySlider.addEventListener('input', function () {
      const value = parseInt(this.value);
      memoryValue.textContent = `${value} GB`;
      memoryHidden.value = value;

      // Update recommendation text based on current game
      const gameId = selectedGameId || document.getElementById('game_id').value;
      if (gameId && gameConfigs[gameId]) {
        const game = gameConfigs[gameId];
        const minGB = Math.ceil(game.minMemoryMB / 1024);
        const recGB = Math.ceil(game.recMemoryMB / 1024);

        if (value < minGB) {
          memoryRecommendation.textContent = '‚ö†Ô∏è Below minimum';
          memoryRecommendation.className = 'text-xs text-red-500';
        } else if (value < recGB) {
          memoryRecommendation.textContent = 'üìä Above minimum';
          memoryRecommendation.className = 'text-xs text-orange-500';
        } else {
          memoryRecommendation.textContent = '‚úÖ Recommended';
          memoryRecommendation.className = 'text-xs text-green-500';
        }
      }
    });
  }

  // CPU slider functionality
  function setupCpuSlider() {
    const cpuSlider = document.getElementById('cpu_slider');
    const cpuValue = document.getElementById('cpu-value');
    const cpuHidden = document.getElementById('cpu_cores');

    if (!cpuSlider) return;

    cpuSlider.addEventListener('input', function () {
      const value = parseFloat(this.value);
      cpuValue.textContent = value === 0 ? 'Unlimited' : `${value} cores`;
      cpuHidden.value = value;
    });
  }

  // Add environment variable input pair
  function addEnvVar(name = '', value = '') {
    const envVars = document.getElementById('env-vars');
    const div = document.createElement('div');
    div.className = 'flex gap-3 items-center bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-600';

    div.innerHTML = `
    <input type="text" placeholder="VARIABLE_NAME" value="${name}"
           class="flex-1 px-3 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 transition-smooth font-mono">
    <span class="text-gray-500 font-mono">=</span>
    <input type="text" placeholder="value" value="${value}"
           class="flex-1 px-3 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 transition-smooth font-mono">
    <button type="button" onclick="removeEnvVar(this)" 
            class="p-2 text-gray-400 hover:text-red-500 transition-smooth rounded-lg hover:bg-red-50 dark:hover:bg-red-900">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  `;

    envVars.appendChild(div);
  }

  // Remove environment variable input pair
  function removeEnvVar(button) {
    button.parentElement.remove();
  }

  // Toggle boolean config value (for PVP, WHITELIST, etc.)
  function toggleBoolConfig(configName) {
    const toggle = document.getElementById(`config_${configName}`);
    if (!toggle) return;

    const currentValue = toggle.dataset.value === 'true';
    const newValue = !currentValue;

    toggle.dataset.value = newValue.toString();
    toggle.setAttribute('aria-checked', newValue.toString());

    // Update visual state
    const knob = toggle.querySelector('span');
    if (newValue) {
      toggle.classList.remove('bg-gray-200', 'dark:bg-gray-700');
      toggle.classList.add('bg-blue-600');
      knob.classList.remove('translate-x-0');
      knob.classList.add('translate-x-5');
    } else {
      toggle.classList.add('bg-gray-200', 'dark:bg-gray-700');
      toggle.classList.remove('bg-blue-600');
      knob.classList.add('translate-x-0');
      knob.classList.remove('translate-x-5');
    }
  }

  // Create appropriate input for config variable based on type
  function createConfigInput(configVar, currentValue = '') {
    const value = currentValue || configVar.default;
    const inputType = configVar.type || 'text';

    switch (inputType) {
      case 'boolean':
        return createBooleanInput(configVar, value);
      case 'number':
        return createNumberInput(configVar, value);
      case 'password':
        return createPasswordInput(configVar, value);
      case 'select':
        return createSelectInput(configVar, value);
      default:
        return createTextInput(configVar, value);
    }
  }

  function createTextInput(configVar, value) {
    return `
      <div class="space-y-2">
        <label for="config_${configVar.name}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
          ${configVar.displayName}
          ${configVar.required ? '<span class="text-red-500 ml-1">*</span>' : ''}
        </label>
        <input type="text" id="config_${configVar.name}" name="config_${configVar.name}"
               value="${value}" ${configVar.required ? 'required' : ''}
               class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 transition-smooth">
        <p class="text-xs text-gray-500 dark:text-gray-400">${configVar.description}</p>
      </div>
    `;
  }

  function createNumberInput(configVar, value) {
    return `
      <div class="space-y-2">
        <label for="config_${configVar.name}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
          ${configVar.displayName}
          ${configVar.required ? '<span class="text-red-500 ml-1">*</span>' : ''}
        </label>
        <input type="number" id="config_${configVar.name}" name="config_${configVar.name}"
               value="${value}" ${configVar.required ? 'required' : ''}
               class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 transition-smooth">
        <p class="text-xs text-gray-500 dark:text-gray-400">${configVar.description}</p>
      </div>
    `;
  }

  function createPasswordInput(configVar, value) {
    return `
      <div class="space-y-2">
        <label for="config_${configVar.name}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
          ${configVar.displayName}
          ${configVar.required ? '<span class="text-red-500 ml-1">*</span>' : ''}
        </label>
        <input type="password" id="config_${configVar.name}" name="config_${configVar.name}"
               value="${value}" ${configVar.required ? 'required' : ''}
               class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 transition-smooth">
        <p class="text-xs text-gray-500 dark:text-gray-400">${configVar.description}</p>
      </div>
    `;
  }

  function createBooleanInput(configVar, value) {
    const isChecked = value === 'true' || value === '1';
    return `
      <div class="space-y-2">
        <div class="flex items-center justify-between">
          <div>
            <label for="config_${configVar.name}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
              ${configVar.displayName}
              ${configVar.required ? '<span class="text-red-500 ml-1">*</span>' : ''}
            </label>
            <p class="text-xs text-gray-500 dark:text-gray-400">${configVar.description}</p>
          </div>
          <button type="button" id="config_${configVar.name}" onclick="toggleBoolConfig('${configVar.name}')"
                  class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${isChecked ? 'bg-blue-600' : 'bg-gray-200 dark:bg-gray-700'}"
                  role="switch" aria-checked="${isChecked}" data-value="${isChecked}">
            <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${isChecked ? 'translate-x-5' : 'translate-x-0'}"></span>
          </button>
        </div>
      </div>
    `;
  }

  function createSelectInput(configVar, value) {
    // Parse options from "value1=Label 1,value2=Label 2" format
    let optionsHtml = '';
    if (configVar.options) {
      const pairs = configVar.options.split(',');
      pairs.forEach(pair => {
        const [optValue, optLabel] = pair.split('=');
        if (optValue !== undefined) {
          const label = optLabel || optValue;
          const selected = optValue.trim() === value ? 'selected' : '';
          optionsHtml += `<option value="${optValue.trim()}" ${selected}>${label.trim()}</option>`;
        }
      });
    }

    return `
      <div class="space-y-2">
        <label for="config_${configVar.name}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
          ${configVar.displayName}
          ${configVar.required ? '<span class="text-red-500 ml-1">*</span>' : ''}
        </label>
        <select id="config_${configVar.name}" name="config_${configVar.name}" ${configVar.required ? 'required' : ''}
                class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 transition-smooth">
          ${optionsHtml}
        </select>
        <p class="text-xs text-gray-500 dark:text-gray-400">${configVar.description}</p>
      </div>
    `;
  }

  // Update memory recommendations and color tick marks
  function updateMemoryRecommendations(gameId) {
    const game = gameConfigs[gameId];
    if (!game) return;

    const minGB = Math.ceil(game.minMemoryMB / 1024);
    const recGB = Math.ceil(game.recMemoryMB / 1024);
    const memorySlider = document.getElementById('memory_slider');

    // Update slider to recommended value (only for new servers)
    if (!isEditMode && memorySlider) {
      memorySlider.value = recGB;
      document.getElementById('memory_gb').value = recGB;
      document.getElementById('memory-value').textContent = `${recGB} GB`;
    }

    // Reset all tick marks to default color
    for (let i = 1; i <= 16; i++) {
      const tick = document.getElementById(`tick-${i}`);
      if (tick) {
        tick.className = 'text-gray-400';
      }
    }

    // Color the min and rec tick marks
    const minTick = document.getElementById(`tick-${minGB}`);
    const recTick = document.getElementById(`tick-${recGB}`);

    if (minTick) {
      minTick.className = 'text-orange-500 font-semibold';
    }
    if (recTick) {
      recTick.className = 'text-green-500 font-semibold';
    }

    // Trigger memory slider update
    if (memorySlider) {
      memorySlider.dispatchEvent(new Event('input'));
    }
  }

  // Load mods for selected game
  function loadModsForGame(gameId) {
    const modsSection = document.getElementById('mods-section');
    const modsFields = document.getElementById('mods-fields');
    const noModsMessage = document.getElementById('no-mods-message');

    if (!modsSection || !modsFields) return;

    const mods = gameMods[gameId] || [];

    if (mods.length === 0) {
      modsSection.style.display = 'none';
      return;
    }

    modsSection.style.display = 'block';
    modsFields.innerHTML = '';
    noModsMessage.classList.add('hidden');

    mods.forEach(mod => {
      {{if $isEdit}}
      const isChecked = currentEnabledMods.includes(mod.id);
      {{else}}
      const isChecked = false;
      {{end}}

      const div = document.createElement('div');
      div.className = 'flex items-start space-x-3 p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700';
      div.innerHTML = `
        <input type="checkbox" id="mod_${mod.id}" name="mods" value="${mod.id}" ${isChecked ? 'checked' : ''}
               class="mt-1 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
        <div class="flex-1">
          <label for="mod_${mod.id}" class="block text-sm font-medium text-gray-900 dark:text-gray-100 cursor-pointer">
            ${mod.name}
          </label>
          <p class="text-xs text-gray-500 dark:text-gray-400">${mod.description}</p>
        </div>
      `;
      modsFields.appendChild(div);
    });
  }

  // Load game configuration
  function loadGameConfiguration(gameId) {
    const configSection = document.getElementById('config-section');
    const configFields = document.getElementById('config-fields');

    if (!gameId || !gameConfigs[gameId]) {
      configSection.style.display = 'none';
      return;
    }

    const game = gameConfigs[gameId];
    configFields.innerHTML = '';

    if (game.configVars.length > 0) {
      configSection.style.display = 'block';

      {{if $isEdit}}
      const configVarNames = new Set();
      {{end}}

      game.configVars.forEach(configVar => {
        {{if $isEdit}}
        configVarNames.add(configVar.name);
        {{end}}
        const fieldDiv = document.createElement('div');
        {{if $isEdit}}
        const currentValue = currentEnv[configVar.name] || '';
        fieldDiv.innerHTML = createConfigInput(configVar, currentValue);
        {{else}}
        fieldDiv.innerHTML = createConfigInput(configVar);
        {{end}}
        configFields.appendChild(fieldDiv);
      });

      {{if $isEdit}}
      // Add remaining environment variables to advanced section
      const envVarsContainer = document.getElementById('env-vars');
      Object.entries(currentEnv).forEach(([name, value]) => {
        if (!configVarNames.has(name)) {
          addEnvVar(name, value);
        }
      });
      {{end}}
    }

    // Update memory recommendations
    updateMemoryRecommendations(gameId);

    // Update port fields if in manual mode
    if (isManualPortMode) {
      populatePortFields(gameId);
    }

    // Load mods for this game
    loadModsForGame(gameId);
  }

  // Handle game selection change (only for new servers)
  {{if not $isEdit}}
  document.getElementById('game_id').addEventListener('change', function () {
    loadGameConfiguration(this.value);
    // Ensure memory recommendations are updated immediately
    updateMemoryRecommendations(this.value);
  });
  {{end}}


  // Initialize form
  function initializeForm() {
    // Setup slider event handlers
    setupMemorySlider();
    setupCpuSlider();
    setupFormSubmission();

    {{if $isEdit}}
    // Load configuration for edit mode
    loadGameConfiguration('{{$gameserver.GameID}}');
    {{else}}
    // Check for game_id URL parameter to pre-select a game
    const urlParams = new URLSearchParams(window.location.search);
    const preselectedGameId = urlParams.get('game_id');
    if (preselectedGameId && gameConfigs[preselectedGameId]) {
      selectGame(preselectedGameId);
    }
    {{end}}

    // Initialize slider values
    const memorySlider = document.getElementById('memory_slider');
    const cpuSlider = document.getElementById('cpu_slider');
    if (memorySlider) memorySlider.dispatchEvent(new Event('input'));
    if (cpuSlider) cpuSlider.dispatchEvent(new Event('input'));
  }

  // Initialize on both page load and HTMX content swap
  document.addEventListener('DOMContentLoaded', initializeForm);
  document.addEventListener('htmx:afterSwap', initializeForm);

  // Setup form submission handler
  function setupFormSubmission() {
    const form = document.querySelector('form');
    if (!form || form.dataset.initialized) return;
    form.dataset.initialized = 'true';

    form.addEventListener('submit', handleFormSubmit);
  }

  // Handle form submission
  function handleFormSubmit(e) {
    const gameId = document.getElementById('game_id').value;
    if (!gameId) return;

    // Create hidden environment textarea to send to server
    let envTextarea = document.getElementById('environment');
    if (!envTextarea) {
      envTextarea = document.createElement('textarea');
      envTextarea.name = 'environment';
      envTextarea.style.display = 'none';
      this.appendChild(envTextarea);
    }

    const envVars = [];

    // Collect config values
    if (gameConfigs[gameId]) {
      gameConfigs[gameId].configVars.forEach(configVar => {
        const input = document.getElementById(`config_${configVar.name}`);
        if (input) {
          let value;
          if (input.type === 'checkbox') {
            value = input.checked ? 'true' : 'false';
          } else if (input.dataset.value !== undefined) {
            // Boolean toggle using data-value attribute
            value = input.dataset.value;
          } else {
            value = input.value.trim();
          }

          if (value) {
            envVars.push(`${configVar.name}=${value}`);
          }
        }
      });
    }

    // Collect custom env vars from advanced section
    const envVarInputs = document.querySelectorAll('#env-vars > div');
    envVarInputs.forEach(div => {
      const inputs = div.querySelectorAll('input');
      if (inputs.length === 2 && inputs[0].value.trim() && inputs[1].value.trim()) {
        envVars.push(`${inputs[0].value.trim()}=${inputs[1].value.trim()}`);
      }
    });

    envTextarea.value = envVars.join('\n');

    // Collect port mappings if in manual mode
    const portModeHidden = document.getElementById('port_mode');
    const portMappingsHidden = document.getElementById('port_mappings');

    if (portModeHidden && portModeHidden.value === 'manual' && gameConfigs[gameId]) {
      const portMappings = [];
      const game = gameConfigs[gameId];

      // Build port mappings from form inputs
      game.portMappings.forEach(pm => {
        const input = document.getElementById(`port_${pm.name}`);
        if (input && input.value) {
          portMappings.push({
            name: pm.name,
            protocol: pm.protocol,
            container_port: pm.containerPort,
            host_port: parseInt(input.value, 10)
          });
        }
      });

      if (portMappingsHidden) {
        portMappingsHidden.value = JSON.stringify(portMappings);
      }
    }
  }

  {{if $isEdit}}
  // Update and restart function
  function updateAndRestart() {
    const form = document.querySelector('form');
    if (!form) return;

    // Submit the form and on success, restart
    const formEvent = new Event('submit', {bubbles: true, cancelable: true});
    handleFormSubmit.call(form, formEvent);

    htmx.ajax('PUT', `/{{$gameserver.ID}}`, {
      source: form,
      swap: 'none'
    }).then(() => {
      // On successful update, restart the server
      return htmx.ajax('POST', `/{{$gameserver.ID}}/restart`, {swap: 'none'});
    }).then(() => {
      showNotification('Server updated and restarted successfully', 'success');
    }).catch(() => {
      showNotification('Failed to update and restart server', 'error');
    });
  }
  {{end}}
</script>
